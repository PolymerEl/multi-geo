<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../multi-chart/helper/multi-accessor.html">
<link rel="import" href="../../multi-chart/helper/polymer-extends-mixin.html">
<dom-module id="multi-project">
  <template>
    <multi-accessor accessor="{{coordinateAccessor}}" path="[[coordinateAccessorPath]]"></multi-accessor>
  </template>
  <script>
  (function() {

    /**
     * ## MultiProject
     *
     * `<multi-project>` use `projection` to project `data` and expose it under `projectedData`
     *
     * @memberof MultiChart
     * @customElement
     * @polymer
     * @appliesMixin MultiChart.mixin.PolymerExtends
     * @demo
     **/
    class MultiProject extends 
    	MultiChart.mixin.PolymerExtends(Polymer.Element) {

      static get is() { return 'multi-project'; }

      static get properties() {
        return {
          /**
           * `projection` the [projection](https://github.com/d3/d3-geo#projection) generator function
           */
          projection: {
            type: Function,
          },

          /**
           * [`data`] data with points to be projected
           */
          data: {
            type: Array,
          },

          /**
           * [`data`] data with points to be projected
           */
          projectedData: {
            type: Array,
            notify: true
          },

          /**
           * `coordinateAccessorPath` path for computing the `valueAccessor` function
           * a value of ´key´ will generate  an accessor function like ´function(d) {return d.key}´ 
           * a value of ´+value.count´ will generate  an accessor function like ´function(d) {return +d.value.count}´ 
           */
          coordinateAccessorPath: {
            type: String
          },

          /**
           * `coordinates` accessor function returning [x,y] coordinates from the data. Passed directly or through a coordinatePath
           */
          coordinateAccessor: {
            type: Function
          },

          /**
           * `key` the key under which projected coordinates are stored
           */
          key: {
            type: String,
            value: '__point__'
          }
        };
      }

      static get observers() {
        return [
          '_computeProjection(projection, coordinateAccessor, data, key)',
        ];
      }

      _computeProjection(projection, coordinateAccessor, data, key) {
        if (projection && coordinateAccessor && data && key) {
          data.forEach(function(d) {
            d[key] = projection(coordinateAccessor(d));
          });
          this.set('projectedData', data);
          this.fire('multi-refresh');
        }
      }
    }

    customElements.define(MultiProject.is, MultiProject);

    if (!window.MultiChart) {
      window.MultiChart = {};
    }

    /* 
     * @namespace MultiChart
     */
    window.MultiChart.MultiProject = MultiProject;

  })();
  </script>
</dom-module>