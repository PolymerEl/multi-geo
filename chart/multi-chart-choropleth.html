<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../topojson/topojson-feature.html">
<link rel="import" href="../topojson/topojson-mesh.html">
<link rel="import" href="../container/multi-container-geo.html">
<link rel="import" href="../drawable/multi-drawable-choropleth.html">
<link rel="import" href="../drawable/multi-drawable-path.html">
<link rel="import" href="../../multi-chart/container/multi-container-g.html">

<dom-module id="multi-chart-choropleth">
	<template>
		<topojson-feature 
			feature="{{feature}}" 
			data="{{geometries}}" 
			name="[[featureName]]" 
			geo-type="[[geoType]]"
			filter="[[featureFilter]]"
			for-each="[[featureForEach]]"
			url="[[featureUrl]]"></topojson-feature>
    <!-- get a topojson mesh for states  -->
    <template is="dom-if" if="[[meshName]]">
    	<topojson-mesh 
    		mesh="{{mesh}}" 
    		data="[[geometries]]" 
    		name="[[meshName]]"></topojson-mesh>
    </template>
    <!-- a multi-container-geo will expose path and projection -->
    <multi-container-geo
      id="chart"

      enable-zoom
      projection="{{projection}}"
      path="{{path}}"
      projection-type="[[projectionType]]"
      scale="{{scale}}"
      clip-angle="[[clipAngle]]"
      clip-extent="[[clipExtent]]"
      center="[[center]]"
      rotate="[[rotate]]"
      precision="[[precision]]"
      translate="[[translate]]"
      >
        <!-- group of geo elements. When choropleth changes, contained elements will redraw -->
        <multi-container-g>
   
          <!-- draw choropleths with projected to projection -->
          <multi-drawable-choropleth 
            data="[[data]]"
            auto-fit
            geo-data="[[feature]]"  
            path="[[path]]"
            attrs="[[choroplethAttrs]]" 
            scale-type="[[colorScaleType]]"
            domain="[[colorDomain]]"
           	domain-min="[[colorDomainMin]]" 
     				domain-max="[[colorDomainMax]]" 
            range="[[colorRange]]"
            color-scale="{{colorScale}}" 
            value-accessor-path="[[valueAccessorPath]]"  
            value-accessor="[[valueAccessor]]"  
            key-accessor-path="[[keyAccessorPath]]"  
            key-accessor="[[keyAccessor]]"  
            feature-accessor-path="[[featureAccessorPath]]"  
            feature-accessor="[[featureAccessor]]"  
            ></multi-drawable-choropleth>
          
          <!-- show mesh -->
					<template is="dom-if" if="[[mesh]]">
	          <multi-drawable-path 
	            path="[[path]]" 
	            attrs="[[meshAttrs]]" 
	            geo-data="[[mesh]]"
	            ></multi-drawable-path>
					</template>
        
        </multi-container-g>
        <slot name="header" slot="header"></slot>
				<slot></slot>			
	  		<slot name="footer" slot="footer"></slot>
      </multi-container-geo>

	</template>

	<script>
		(function() {

		/**
		 * ## MultiChartChoropleth
		 *
		 * `<multi-chart-choropleth>` a choropleth-chart 
		 *
		 * @memberof MultiChart
		 * @customElement
     * @polymer
     * @demo
		 **/
		class MultiChartChoropleth extends 
			MultiChart.mixin.D3Projection(
				MultiChart.mixin.ColorScale(
					Polymer.Element)) {

			static get is() { return 'multi-chart-choropleth'; }

			static get properties() {
				return {

          /**
           * `projection` the [projection](https://github.com/d3/d3-geo#projection) generator function
           */
          projection: {
            type: Function,
            notify: true
          },


					/**
           * `feature` the GeoJSON Feature or FeatureCollection to be exposed by this component
           */
          feature: {
            type: Array,
            notify: true
          },

					 /* 
           * `featureUrl` url to use for fetching geo mesh data.
           */
          featureUrl: {
            type: String
          },

          /**
           * `geometries` topojson or geojson object. It is either retrieved iron-ajax or passed as an argument
           */
          geometries: {
            type: Object,
            notify: true
          },

          /**
           * `geoType` the type of data object (topojson or geojson)
           */
          geoType: {
            type: String,
            value: 'topojson'
          },

          /**
           * `featureName` the name of the property to extract from the geo data object
           */
          featureName: {
            type: String
          },

          /* 
           * `featureFilter` the filter to use for filtering features
           * ex: function(f) {return f.id !== 10} // remove antartic from a world map
           */
          featureFilter: {
            type: Function
          },

          /* 
           * `featureForEach` a function that will run for each feature
           * ex: function(f) {return f.properties.id = lookup(f.id) } // take lookup code
           */
          featureForEach: {
            type: Function
          },

          /**
           * `feature` the geo feature to be exposed by this component
           */
          mesh: {
            type: Array,
            notify: true
          },


          /**
           * `meshName` the name of the property to extract from the geo data object
           */
          meshName: {
            type: String
          },

          /* 
           * `meshAttrs` attributes to be set on the mesh
           */
           meshAttrs : {
            type:  String,
            value: null
           },


 					/* 
           * `colorScale` scale to use for the choropleth
           */
          colorScale: {
            type: Function,
            notify: true
          },

          /* 
           * `choroplethAttrs` default attributes to be set on the chart
           */
           choroplethAttrs : {
           	type:  String,
           	value: null
           },

           /* 
            * `colorScaleType` type of scale for the color scale
            */
            colorScaleType : {
            	type:  String,
            	value: 'scaleQuantize'
            },

            /* 
             * `colorDomain` domain for color scale 
             */
             colorDomain : {
             	type:  Array,
             },

						/* 
             * `colorRange` domain for color scale 
             */
             colorRange : {
             	type:  Array,
             	value: function() {
             		return d3.schemeBlues[8];
             	}
             },

             /* 
              * `colorDomainMin` min value for color domain
              */
              colorDomainMin : {
              	type:  Number,
              },
             
             /* 
              * `colorDomainMax` max value for color domain
              */
              colorDomainMax : {
              	type:  Number,
              }, 	

             /**
	           * `valueAccessorPath` path for computing the `valueAccessor` function
	           * a value of ´key´ will generate  an accessor function like ´function(d) {return d.key}´ 
	           * a value of ´+value.count´ will generate  an accessor function like ´function(d) {return +d.value.count}´ 
	           */
	          valueAccessorPath: {
	            type: String,
	            value: 'key'
	          },

	          /**
	           * `valueAccessor` the value accessor function 
	           * example function : `d => {return +d.count}`
	           */
	          valueAccessor: {
	            type: Function
	          },

	          /**
	           * `keyAccessorPath` path for computing the `keyAccessor` function
	           * a key of ´key´ will generate  an accessor function like ´function(d) {return d.key}´ 
	           * a key of ´+key.count´ will generate  an accessor function like ´function(d) {return +d.key.count}´ 
	           */
	          keyAccessorPath: {
	            type: String,
	            value: 'key'
	          },

	          /**
	           * `keyAccessor` the value accessor function 
	           * example function : `d => {return +d.count}`
	           */
	          keyAccessor: {
	            type: Function
	          },

          /**
           * `featureAccessorPath` the path for accessing the feature keys/ids
           */
          featureAccessorPath: {
            type: String,
            value: 'id'
          },

          /**
           * `featureAccessor the accessor function from featureAccessorPath.
           */
          featureAccessor: {
            type: Function
          },


				};
			}
		}

		customElements.define(MultiChartChoropleth.is, MultiChartChoropleth);

		if (!window.MultiChart) {
		  window.MultiChart = {};
		}
   
   /* 
    * @namespace MultiChart
    */
    window.MultiChart.MultiChartChoropleth = MultiChartChoropleth;

		})();
	</script>
</dom-module>