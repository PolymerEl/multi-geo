<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<dom-module id="topojson-feature">
  <template>
    <iron-ajax auto url="[[url]]" handle-as="[[handleAs]]" last-response="{{data}}"></iron-ajax>
  </template>
  <script>
  (function() {

    /**
     * ## TopojsonFeature
     *
     * `<topojson-feature>` a wrapper around [topojson feature](https://github.com/topojson/topojson-client/blob/master/README.md#feature)
     * exposes geo feature from an url
     *
     * @memberof MultiChart
     * @customElement
     * @polymer
     * @demo
     **/
    class TopojsonFeature extends Polymer.Element {

      static get is() { return 'topojson-feature'; }

      static get properties() {
        return {
          /**
           * `feature` the GeoJSON Feature or FeatureCollection to be exposed by this component
           */
          feature: {
            type: Array,
            notify: true
          },

          /* 
           * `url` url to use for fetching geo mesh data.
           */
          url: {
            type: String
          },

          /**
           * `data` topojson or geojson object. It is either retrieved iron-ajax or passed as an argument
           */
          data: {
            type: Object,
            notify: true
          },

          /**
           * `geoType` the type of data object (topojson or geojson)
           */
          geoType: {
            type: String,
            value: 'topojson'
          },

          /**
           * `name` the name of the property to extract from the geo data object
           */
          name: {
            type: String
          },

          /**
           * [`handleAs`](https://elements.polymer-project.org/elements/iron-ajax#property-handleAs) 
           */
          handleAs: {
            type: String,
            value: 'json'
          },

          /* 
           * `filter` the filter to use for filtering features
           * ex: function(f) {return f.id !== 10} // remove antartic from a world map
           */
          filter: {
            type: Function
          },

          /* 
           * `forEach` a function that will run for each feature
           * ex: function(f) {return f.properties.id = lookup(f.id) } // take lookup code
           */
          forEach: {
            type: Function
          }
        };
      }
      static get observers() {
        return ['_observeData(data, name, geoType, filter, forEach)'];
      }

      _observeData(data, name, geoType, filter, forEach) {
        if (data && name && geoType) {
          let feature;
          
          if (geoType === 'topojson') {
            if(!data.objects[name]) {
              throw `no topologies for name ${name}`;
            }
            feature = topojson.feature(data, data.objects[name]);
          } else {
            feature = data.objects[name].geometries;
          }
          
          if (feature && feature.features && filter && typeof filter === 'function') {
            feature.features = feature.features.filter(filter);
          }
          
          if (feature && feature.features && forEach && typeof forEach === 'function') {
            feature.features.forEach(forEach);
          }
          this.debounce('topojson-feature-observe-data', function() {
            this.feature = feature;
          }, 50);
        }
      }
    }

    customElements.define(TopojsonFeature.is, TopojsonFeature);

    if (!window.MultiChart) {
      window.MultiChart = {};
    }

    /* 
     * @namespace MultiChart
     */
    window.MultiChart.TopojsonFeature = TopojsonFeature;

  })();
  </script>
</dom-module>